# Документ требований

## Введение
SHIELD Audit Logging — модуль детального логирования security-событий для compliance (SOC 2, HIPAA, PCI-DSS). Система записывает все события безопасности (детекции, блокировки, bypass-попытки) в структурированном формате с гарантиями целостности и неизменяемости.

## Требования

### Требование 1: Запись security-событий
**Цель:** Как администратор безопасности, я хочу получать полную запись всех security-событий, чтобы иметь аудиторский след для compliance.

#### Критерии приёмки
1. Когда SHIELD обнаруживает угрозу, система должна записать событие со всеми метаданными (timestamp, source IP, threat type, severity, action taken)
2. Когда запрос блокируется, система должна записать полный контекст (request ID, rule matched, payload hash)
3. Когда происходит bypass-попытка, система должна записать событие с повышенным приоритетом и alert flag
4. Система должна записывать события со скоростью ≥10K событий/сек без деградации производительности SHIELD

### Требование 2: Структурированный формат логов
**Цель:** Как SOC-аналитик, я хочу логи в стандартизированном формате, чтобы легко интегрировать их с SIEM.

#### Критерии приёмки
1. Система должна генерировать логи в формате JSON Lines (JSONL)
2. Когда событие записывается, оно должно содержать поля: timestamp (ISO 8601), event_type, severity (1-10), source, target, action, result, metadata
3. Система должна поддерживать экспорт в форматах CEF (Common Event Format) и LEEF (Log Event Extended Format)
4. Где требуется syslog-совместимость, система должна генерировать RFC 5424 сообщения

### Требование 3: Целостность и неизменяемость
**Цель:** Как compliance-офицер, я хочу гарантию неизменяемости логов, чтобы они были допустимы как доказательства.

#### Критерии приёмки
1. Когда лог-запись создаётся, система должна вычислить SHA-256 хеш и добавить в цепочку хешей
2. Если обнаружено нарушение цепочки хешей, система должна генерировать критический alert
3. Система должна поддерживать append-only режим записи (no delete, no update)
4. Пока система работает, она должна периодически (каждые 60 сек) верифицировать целостность последних 1000 записей

### Требование 4: Ротация и архивирование
**Цель:** Как DevOps инженер, я хочу автоматическую ротацию логов, чтобы управлять дисковым пространством.

#### Критерии приёмки
1. Когда файл лога достигает настраиваемого размера (по умолчанию 100MB), система должна ротировать его
2. Система должна сохранять настраиваемое количество архивных файлов (по умолчанию 10)
3. Когда архив создаётся, система должна сжать его в gzip формате
4. Система должна поддерживать настройку retention period (по умолчанию 90 дней)

### Требование 5: Экспорт и интеграция
**Цель:** Как integration-инженер, я хочу экспортировать логи в внешние системы, чтобы централизовать мониторинг.

#### Критерии приёмки
1. Система должна поддерживать прямую отправку в syslog (UDP/TCP/TLS)
2. Где настроен webhook, система должна отправлять события в HTTP endpoint
3. Система должна поддерживать batch-экспорт в S3-совместимое хранилище
4. Если внешняя система недоступна, система должна буферизировать события локально и retry с exponential backoff

### Требование 6: Производительность
**Цель:** Как SRE, я хочу минимальное влияние логирования на латентность, чтобы не деградировать основную функцию SHIELD.

#### Критерии приёмки
1. Система должна добавлять не более 50μs латентности на запрос
2. Система должна использовать асинхронную запись с ring buffer
3. Если буфер заполнен, система должна применить backpressure (drop oldest) и инкрементировать счётчик dropped_events
4. Система должна предоставлять метрики: events_logged, events_dropped, avg_write_latency, buffer_utilization
